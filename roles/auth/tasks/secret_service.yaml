---
- name: Check if GNOME keyring daemon is running
  ansible.builtin.command: pgrep -f gnome-keyring-daemon
  changed_when: false
  ignore_errors: true
  register: pgrep_result

- name: Kill keyring daemon if it is running
  ansible.builtin.command: pkill -f gnome-keyring-daemon
  when: pgrep_result.rc == 0
  changed_when: true

- name: Ensure that desktop autostart folder exists
  ansible.builtin.file:
    path: "{{ local_autostart_location }}"
    state: directory
    mode: "755"

- name: Prevent keyring daemon from starting on login
  ansible.builtin.copy:
    src: hidden.desktop
    dest: "{{ local_autostart_location }}/{{ item }}"
    mode: "644"
  loop:
    - gnome-keyring-pkcs11.desktop
    - gnome-keyring-secrets.desktop
    - gnome-keyring-ssh.desktop

- name: Enable KeePassXC Secret Service integration
  community.general.ini_file:
    path: "{{ keepassxc_config_file_location }}"
    section: FdoSecrets
    option: Enabled
    value: "true"
    no_extra_spaces: true
    mode: "644"
    state: present

- name: Ensure that local user systemd units folder exists
  ansible.builtin.file:
    path: "{{ local_user_systemd_location }}"
    state: directory
    mode: "755"

- name: Ensure SSH agent service file is present
  ansible.builtin.copy:
    src: ssh-agent.service
    dest: "{{ local_user_systemd_location }}/ssh-agent.service"
    mode: "644"

- name: Start SSH agent service on boot
  ansible.builtin.systemd_service:
    name: ssh-agent
    scope: user
    state: started
    enabled: true

- name: Ensure that local DBus service folder exists
  ansible.builtin.file:
    path: "{{ local_user_dbus_location }}"
    state: directory
    mode: "755"

- name: Ensure local DBus secrets service file is present
  ansible.builtin.copy:
    src: org.freedesktop.secrets.service
    dest: "{{ local_user_dbus_location }}/org.freedesktop.secrets.service"
    mode: "644"
